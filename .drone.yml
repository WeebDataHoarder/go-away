---
environment:
  CGO_ENABLED: "0"
  GOARCH: amd64
  GOOS: linux
  GOTOOLCHAIN: local
kind: pipeline
name: build-1.22-alpine3.20-amd64
platform:
  arch: amd64
  os: linux
steps:
- commands:
  - apk update
  - apk add --no-cache git
  - mkdir .bin
  - go build -v -pgo=auto -v -trimpath -ldflags=-buildid= -o ./.bin/go-away ./cmd/go-away
  - go build -v -o ./.bin/test-wasm-runtime ./cmd/test-wasm-runtime
  image: golang:1.22-alpine3.20
  mirror: https://mirror.gcr.io
  name: build
- commands:
  - ./.bin/go-away --check --slog-level DEBUG --backend example.com=http://127.0.0.1:80
    --policy examples/forgejo.yml --policy-snippets examples/snippets/
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: check-policy-forgejo
- commands:
  - ./.bin/go-away --check --slog-level DEBUG --backend example.com=http://127.0.0.1:80
    --policy examples/generic.yml --policy-snippets examples/snippets/
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: check-policy-generic
- commands:
  - ./.bin/go-away --check --slog-level DEBUG --backend example.com=http://127.0.0.1:80
    --policy examples/spa.yml --policy-snippets examples/snippets/
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: check-policy-spa
- commands:
  - ./.bin/test-wasm-runtime -wasm ./embed/challenge/js-pow-sha256/runtime/runtime.wasm
    -make-challenge ./embed/challenge/js-pow-sha256/test/make-challenge.json -make-challenge-out
    ./embed/challenge/js-pow-sha256/test/make-challenge-out.json -verify-challenge
    ./embed/challenge/js-pow-sha256/test/verify-challenge.json -verify-challenge-out
    0
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: test-wasm-success
- commands:
  - ./.bin/test-wasm-runtime -wasm ./embed/challenge/js-pow-sha256/runtime/runtime.wasm
    -make-challenge ./embed/challenge/js-pow-sha256/test/make-challenge.json -make-challenge-out
    ./embed/challenge/js-pow-sha256/test/make-challenge-out.json -verify-challenge
    ./embed/challenge/js-pow-sha256/test/verify-challenge-fail.json -verify-challenge-out
    1
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: test-wasm-fail
type: docker
---
environment:
  CGO_ENABLED: "0"
  GOARCH: arm64
  GOOS: linux
  GOTOOLCHAIN: local
kind: pipeline
name: build-1.22-alpine3.20-arm64
platform:
  arch: arm64
  os: linux
steps:
- commands:
  - apk update
  - apk add --no-cache git
  - mkdir .bin
  - go build -v -pgo=auto -v -trimpath -ldflags=-buildid= -o ./.bin/go-away ./cmd/go-away
  - go build -v -o ./.bin/test-wasm-runtime ./cmd/test-wasm-runtime
  image: golang:1.22-alpine3.20
  mirror: https://mirror.gcr.io
  name: build
- commands:
  - ./.bin/go-away --check --slog-level DEBUG --backend example.com=http://127.0.0.1:80
    --policy examples/forgejo.yml --policy-snippets examples/snippets/
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: check-policy-forgejo
- commands:
  - ./.bin/go-away --check --slog-level DEBUG --backend example.com=http://127.0.0.1:80
    --policy examples/generic.yml --policy-snippets examples/snippets/
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: check-policy-generic
- commands:
  - ./.bin/go-away --check --slog-level DEBUG --backend example.com=http://127.0.0.1:80
    --policy examples/spa.yml --policy-snippets examples/snippets/
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: check-policy-spa
- commands:
  - ./.bin/test-wasm-runtime -wasm ./embed/challenge/js-pow-sha256/runtime/runtime.wasm
    -make-challenge ./embed/challenge/js-pow-sha256/test/make-challenge.json -make-challenge-out
    ./embed/challenge/js-pow-sha256/test/make-challenge-out.json -verify-challenge
    ./embed/challenge/js-pow-sha256/test/verify-challenge.json -verify-challenge-out
    0
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: test-wasm-success
- commands:
  - ./.bin/test-wasm-runtime -wasm ./embed/challenge/js-pow-sha256/runtime/runtime.wasm
    -make-challenge ./embed/challenge/js-pow-sha256/test/make-challenge.json -make-challenge-out
    ./embed/challenge/js-pow-sha256/test/make-challenge-out.json -verify-challenge
    ./embed/challenge/js-pow-sha256/test/verify-challenge-fail.json -verify-challenge-out
    1
  depends_on:
  - build
  image: alpine:3.20
  mirror: https://mirror.gcr.io
  name: test-wasm-fail
type: docker
---
kind: signature
hmac: 00be8252a86e2c760c07c2baa6efa55d75f46fdc22299bb3feb1b199cc54af9e

...
